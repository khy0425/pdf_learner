<!DOCTYPE html>
<html>
<head>
  <base href="/">
  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="AI PDF Study Assistant - PDF 학습을 위한 스마트 도우미">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <!-- 모바일 웹앱 설정 - 두 태그 모두 포함 -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="PDF Learner">
  
  <!-- 성능 최적화 관련 메타 태그 -->
  <meta name="theme-color" content="#1976D2">
  <meta http-equiv="Cache-Control" content="max-age=3600">
  <meta name="referrer" content="no-referrer-when-downgrade">
  <meta name="format-detection" content="telephone=no">
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  
  <!-- CSP(Content Security Policy) 설정 -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://www.gstatic.com/ https://apis.google.com/ 'unsafe-inline' 'unsafe-eval'; connect-src 'self' https://*.googleapis.com https://*.firebaseio.com https://*.cloudfunctions.net https://pdf-learner.firebaseapp.com; img-src 'self' data: https:; style-src 'self' 'unsafe-inline'; font-src 'self' https://fonts.gstatic.com;">

  <!-- 로그 제어 스크립트 -->
  <script src="js/logger.js"></script>

  <!-- 전역 변수 정의 -->
  <script>
    // 전역 변수 정의
    var serviceWorkerVersion = "null";
    window.serviceWorkerVersion = serviceWorkerVersion;
    
    // Flutter 웹 렌더러 설정 - HTML로 변경
    window.flutterWebRenderer = "html";
    
    // 성능 향상을 위한 설정
    window.isFlutterInAppWebView = false;
    window.flutterCanvasKit = false;
  </script>

  <link rel="apple-touch-icon" href="icons/Icon-192.png">
  <link rel="icon" type="image/png" href="favicon.png"/>
  
  <!-- 리소스 사전 로드 -->
  <link rel="preload" href="main.dart.js" as="script">
  
  <title>PDF Learner</title>
  <link rel="manifest" href="manifest.json">

  <style>
    body {
      background-color: #FFFFFF;
      margin: 0;
      padding: 0;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
      position: fixed;
      top: 0;
      left: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    /* Flutter 타겟 설정 */
    #flutter_target {
      background-color: #FFFFFF;
      color: #000000;
      position: absolute !important;
      top: 0 !important;
      left: 0 !important;
      width: 100% !important;
      height: 100% !important;
      display: block !important;
      visibility: visible !important;
      z-index: 2 !important;
      opacity: 1 !important;
    }

    /* 로딩 화면 */
    #loading {
      display: flex;
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 100%;
      justify-content: center;
      align-items: center;
      background-color: #FFFFFF;
      transition: opacity .4s ease-out;
      z-index: 3;
    }

    .loader {
      border: 5px solid #f3f3f3;
      border-radius: 50%;
      border-top: 5px solid #1976D2;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      margin-top: 20px;
      font-size: 16px;
      color: #666;
    }

    /* 오류 UI */
    #error-ui {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background-color: #FFFFFF;
      z-index: 999;
      text-align: center;
      padding: 20px;
    }

    .error-title {
      font-size: 24px;
      font-weight: bold;
      color: #F44336;
      margin-bottom: 16px;
    }

    .error-message {
      font-size: 16px;
      color: #666;
      margin-bottom: 24px;
      max-width: 600px;
    }

    .error-button {
      margin-top: 8px;
      padding: 12px 24px;
      background-color: #F44336;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
  </style>

  <!-- Firebase 설정 파일 (별도 파일로 분리) - 먼저 로드 -->
  <script src="js/firebase-config.js"></script>
  
  <script>
    // 디버그 설정
    var DEBUG = false;
    
    // 안전 로그 함수
    function log(message) {
      if (DEBUG) {
        console.log("[PDF Learner] " + message);
      }
    }
    
    // 전역 객체 및 안전한 함수들
    window.pdfl = {};
    
    // 쿠키 관련 유틸리티 함수
    const Cookies = {
      set: function(name, value, days) {
        let expires = "";
        if (days) {
          const date = new Date();
          date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
          expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + encodeURIComponent(value) + expires + "; path=/; SameSite=Strict; Secure";
      },
      
      get: function(name) {
        const nameEQ = name + "=";
        const ca = document.cookie.split(';');
        for (let i = 0; i < ca.length; i++) {
          let c = ca[i];
          while (c.charAt(0) === ' ') c = c.substring(1, c.length);
          if (c.indexOf(nameEQ) === 0) return decodeURIComponent(c.substring(nameEQ.length, c.length));
        }
        return null;
      },
      
      delete: function(name) {
        document.cookie = name + '=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT; SameSite=Strict; Secure';
      }
    };
    
    // 사용자 정보 가져오기 함수 - Flutter에서 호출
    window.getUserDetails = function() {
      try {
        // 1. Firebase 인증 정보 우선 확인
        if (typeof firebase !== 'undefined' && firebase.auth) {
          var user = firebase.auth().currentUser;
          if (user) {
            log('Firebase에서 인증된 사용자 발견: ' + user.uid);
            
            // 쿠키에 세션 정보만 저장 (민감한 정보 제외)
            const sessionToken = btoa(user.uid + ':' + Date.now());
            Cookies.set('user_session', sessionToken, 7); // 7일간 유효
            
            return {
              uid: user.uid,
              email: user.email || '',
              displayName: user.displayName || '',
              isAnonymous: user.isAnonymous || false
            };
          }
        }
        
        // 2. 세션 쿠키에서 확인
        const sessionToken = Cookies.get('user_session');
        if (sessionToken) {
          try {
            const decoded = atob(sessionToken);
            const parts = decoded.split(':');
            if (parts.length >= 1) {
              const uid = parts[0];
              log('세션 쿠키에서 사용자 ID 발견: ' + uid);
              
              // Firebase에서 사용자 정보 다시 조회 (최신 정보 유지)
              if (typeof firebase !== 'undefined' && firebase.auth) {
                // 세션 있지만 Firebase에는 없는 경우
                log('세션 있음, Firebase에서 사용자 정보 확인 필요');
              }
              
              return {
                uid: uid,
                email: '', // Firebase에서 다시 조회 필요
                displayName: '',
                isAnonymous: false
              };
            }
          } catch (error) {
            log('세션 쿠키 디코딩 오류: ' + error);
          }
        }
        
        // 3. 로그인된 사용자 없음
        log('로그인된 사용자 없음');
        return null;
      } catch (error) {
        log('사용자 정보 가져오기 오류: ' + error);
        return null;
      }
    };
    
    // Firebase 초기화 상태 확인 함수
    window.checkFirebaseStatus = function() {
      try {
        const initialized = typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length > 0;
        let userLoggedIn = false;
        let userId = null;
        
        if (initialized && firebase.auth) {
          const user = firebase.auth().currentUser;
          userLoggedIn = user !== null;
          userId = user ? user.uid : null;
        }
        
        return {
          initialized: initialized,
          userLoggedIn: userLoggedIn,
          userId: userId
        };
      } catch (error) {
        log('Firebase 상태 확인 오류: ' + error);
        return { initialized: false, userLoggedIn: false, userId: null };
      }
    };
  </script>
</head>
<body>
  <!-- 로딩 UI -->
  <div id="loading">
    <div style="text-align: center;">
      <div class="loader"></div>
      <p class="loading-text">PDF Learner 로딩 중...</p>
    </div>
  </div>
  
  <!-- 오류 UI -->
  <div id="error-ui">
    <div class="error-title">문제가 발생했습니다</div>
    <div class="error-message">앱 로딩 중 오류가 발생했습니다. 네트워크 연결을 확인하고 다시 시도해 주세요.</div>
    <button class="error-button" onclick="window.location.reload()">새로고침</button>
  </div>

  <!-- Flutter 컨테이너 -->
  <div id="flutter_target" class="flutter-container"></div>

  <!-- Flutter.js 로딩 - 최적화된 방식 -->
  <script>
    // Flutter.js 로딩 시간 모니터링
    const flutterJsLoadStart = performance.now();
    
    // 타임아웃 설정
    const FLUTTER_LOAD_TIMEOUT = 15000; // 15초 (이전 30초에서 단축)
    
    // Flutter.js 로드에 실패할 경우 대체 방법
    let flutterLoadTimeout = setTimeout(() => {
      console.warn(FLUTTER_LOAD_TIMEOUT + '밀리초 타임아웃 후 대체 방법 시도 중...');
      
      // 1. 로딩 중인 스크립트 중단
      const oldScript = document.querySelector('script[src="flutter.js"]');
      if (oldScript) {
        oldScript.remove();
      }
      
      // 2. 캐싱 방지를 위해 버전 파라미터 추가하여 다시 로드
      loadFlutterWithFallback();
    }, FLUTTER_LOAD_TIMEOUT);
    
    // Flutter 로드 함수
    function loadFlutter() {
      // 스크립트 동적 생성
      const script = document.createElement('script');
      script.src = "flutter.js";
      script.defer = true;
      
      // 로드 이벤트 핸들러 (성공)
      script.onload = function() {
        clearTimeout(flutterLoadTimeout);
        const flutterJsLoadTime = performance.now() - flutterJsLoadStart;
        console.log(`Flutter.js 로드 완료 (${flutterJsLoadTime.toFixed(2)}ms)`);
        
        // Flutter 앱 초기화
        initFlutterApp();
      };
      
      // 오류 이벤트 핸들러 (실패)
      script.onerror = function() {
        console.error('Flutter.js 로드 오류, 대체 방법 시도 중...');
        clearTimeout(flutterLoadTimeout);
        loadFlutterWithFallback();
      };
      
      document.body.appendChild(script);
    }
    
    // 대체 방법 사용하여 Flutter 로드
    function loadFlutterWithFallback() {
      // 파라미터를 추가하여 캐싱 방지
      const timestamp = new Date().getTime();
      const script = document.createElement('script');
      script.src = `flutter.js?v=${timestamp}`;
      script.defer = true;
      
      script.onload = function() {
        console.log('대체 방법으로 Flutter.js 로드 성공');
        initFlutterApp();
      };
      
      script.onerror = function() {
        console.error('Flutter.js 로드 지속 실패');
        // 오류 UI 표시
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error-ui').style.display = 'flex';
      };
      
      document.body.appendChild(script);
    }
    
    // Flutter 앱 초기화
    function initFlutterApp() {
      _flutter.loader.loadEntrypoint({
        serviceWorker: {
          serviceWorkerVersion: serviceWorkerVersion,
        },
        onEntrypointLoaded: async function(engineInitializer) {
          const appRunner = await engineInitializer.initializeEngine({
            renderer: 'html',
            useColorEmoji: true
          });
          
          // Firebase SDK 지연 로드
          loadFirebaseSDKs().then(() => {
            console.log('Firebase SDK 로드 완료');
            appRunner.runApp();
          }).catch((error) => {
            console.error('Firebase SDK 로드 오류:', error);
            // Firebase 없이도 앱 실행 시도
            appRunner.runApp();
          });
        }
      });
    }
    
    // Firebase SDK 지연 로드 함수
    function loadFirebaseSDKs() {
      return new Promise((resolve, reject) => {
        try {
          // 이미 로드되었는지 확인
          if (typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length > 0) {
            console.log('Firebase SDK 이미 로드됨');
            return resolve();
          }
          
          // 필수 SDK만 먼저 로드 (auth와 core)
          const requiredScripts = [
            { src: 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js' },
            { src: 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js' }
          ];
          
          // 나머지 SDK는 지연 로드
          const secondaryScripts = [
            { src: 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js', id: 'firebase-firestore' },
            { src: 'https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js', id: 'firebase-storage' },
            { src: 'https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js', id: 'firebase-analytics' }
          ];
          
          // 필수 SDK 로드 (동기식)
          let loaded = 0;
          
          // 각 필수 스크립트 로드
          requiredScripts.forEach((scriptInfo) => {
            const script = document.createElement('script');
            script.src = scriptInfo.src;
            
            script.onload = () => {
              loaded++;
              if (loaded === requiredScripts.length) {
                // 필수 스크립트 로드 완료, Firebase 초기화
                try {
                  // 아직 초기화되지 않았다면 초기화
                  if (firebase.apps.length === 0) {
                    firebase.initializeApp(firebaseConfig);
                  }
                  
                  // 나머지 SDK 비동기 로드 시작 (백그라운드)
                  loadSecondaryScripts();
                  
                  // 초기화 완료
                  resolve();
                } catch (error) {
                  console.error('Firebase 초기화 오류:', error);
                  reject(error);
                }
              }
            };
            
            script.onerror = (error) => {
              console.error('Firebase SDK 로드 오류:', error);
              reject(error);
            };
            
            document.head.appendChild(script);
          });
          
          // 나머지 SDK 비동기 로드 함수
          function loadSecondaryScripts() {
            secondaryScripts.forEach((scriptInfo) => {
              const script = document.createElement('script');
              script.src = scriptInfo.src;
              script.id = scriptInfo.id;
              script.async = true;
              
              // 개별 SDK 로드 완료 시 트리거 함수 등록
              script.onload = () => {
                if (scriptInfo.id === 'firebase-firestore') {
                  if (window.ff_trigger_firebase_firestore) {
                    window.ff_trigger_firebase_firestore();
                  }
                } else if (scriptInfo.id === 'firebase-storage') {
                  if (window.ff_trigger_firebase_storage) {
                    window.ff_trigger_firebase_storage();
                  }
                } else if (scriptInfo.id === 'firebase-analytics') {
                  if (window.ff_trigger_firebase_analytics) {
                    window.ff_trigger_firebase_analytics();
                  }
                }
              };
              
              document.head.appendChild(script);
            });
          }
        } catch (error) {
          console.error('Firebase SDK 로드 준비 오류:', error);
          reject(error);
        }
      });
    }
    
    // Flutter 로딩 시작
    loadFlutter();
  </script>
</body>
</html> 