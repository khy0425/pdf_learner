<!DOCTYPE html>
<html>
<head>
  <!--
    If you are serving your web app in a path other than the root, change the
    href value below to reflect the base path you are serving from.

    The path provided below has to start and end with a slash "/" in order for
    it to work correctly.

    For more details:
    * https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base

    This is a placeholder for base href that will be replaced by the value of
    the `--base-href` argument provided to `flutter build`.
  -->
  <base href="$FLUTTER_BASE_HREF">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="PDF Learner - AI PDF 학습 도우미">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- iOS meta tags & icons -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="PDF Learner">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>PDF Learner</title>
  <link rel="manifest" href="manifest.json">

  <!-- Flutter 초기화 스크립트 (표준 방식) -->
  <script>
    // The value below is injected by flutter build, do not touch.
    var serviceWorkerVersion = null;
  </script>
  <script src="flutter.js" defer></script>

  <style>
    body {
      background-color: #FFFFFF;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
      margin: 0;
      padding: 0;
      position: fixed;
    }
    
    #loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%;
      width: 100%;
      position: absolute;
      top: 0;
      left: 0;
      background-color: white;
      flex-direction: column;
      z-index: 9999;
    }
    
    .loader {
      border: 8px solid #f3f3f3;
      border-radius: 50%;
      border-top: 8px solid #1976D2;
      width: 60px;
      height: 60px;
      animation: spin 2s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      margin-top: 20px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 18px;
      color: #666;
    }
    
    #error-container {
      display: none;
      color: red;
      text-align: center;
      padding: 20px;
    }
  </style>
</head>
<body>
  <!-- Flutter 앱이 렌더링될 요소 -->
  <div id="flutter_target" style="width: 100%; height: 100%;"></div>
  
  <!-- 로딩 화면 -->
  <div id="loading">
    <div class="loader"></div>
    <div class="loading-text">PDF Learner 로딩 중...</div>
    <div id="error-container">
      <h2>앱 로드 실패</h2>
      <p id="error-message">앱을 로드하는 중 오류가 발생했습니다.</p>
      <button onclick="window.location.reload()" style="padding: 10px 20px; margin-top: 20px; cursor: pointer;">
        새로고침
      </button>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>

  <script>
    // 전역 객체 및 안전한 함수들
    window.pdfl = {};
    
    // Firebase 초기화
    firebase.initializeApp({
      apiKey: "AIzaSyCpTt_AlV22_oeH9A2azgGfHAa19AoTjx0",
      authDomain: "pdf-learner.firebaseapp.com",
      projectId: "pdf-learner",
      storageBucket: "pdf-learner.appspot.com",
      messagingSenderId: "189136888100",
      appId: "1:189136888100:web:784cc4e1fde143cc3e93b1",
      measurementId: "G-0HLX196P5P"
    });
    
    // 사용자 정보 가져오기 함수 - Flutter에서 호출
    window.getUserDetails = function() {
      try {
        // Firebase 인증 정보 확인
        if (typeof firebase !== 'undefined' && firebase.auth) {
          var user = firebase.auth().currentUser;
          if (user) {
            console.log('Firebase에서 인증된 사용자 발견: ' + user.uid);
            return {
              uid: user.uid,
              email: user.email || '',
              displayName: user.displayName || '',
              isAnonymous: false
            };
          }
        }
        
        // 로컬 스토리지에서 확인
        var storedUserInfo = localStorage.getItem('user_info');
        if (storedUserInfo) {
          var userInfo = JSON.parse(storedUserInfo);
          console.log('로컬 스토리지에서 사용자 정보 발견: ' + userInfo.uid);
          return userInfo;
        }
        
        console.log('사용자 정보를 찾을 수 없음');
        return {
          uid: '',
          email: '',
          displayName: '',
          isAnonymous: true
        };
      } catch (e) {
        console.error('사용자 정보 가져오기 오류: ' + e);
        return {
          uid: '',
          email: '',
          displayName: '',
          isAnonymous: true
        };
      }
    };
    
    window.pdfl.getCurrentFirebaseUser = function() {
      return window.getUserDetails();
    };
    
    window.pdfl.getStoredUserInfo = function() {
      return window.getUserDetails();
    };
    
    // 로딩 화면 숨기기 함수
    window.hideLoading = function() {
      var loadingElement = document.getElementById('loading');
      if (loadingElement) {
        loadingElement.style.opacity = '0';
        loadingElement.style.transition = 'opacity 0.5s ease';
        setTimeout(function() {
          loadingElement.style.display = 'none';
        }, 500);
      }
    };
    
    // 오류 표시 함수
    window.showError = function(message) {
      var loadingIndicator = document.querySelector('.loader');
      var loadingText = document.querySelector('.loading-text');
      var errorContainer = document.getElementById('error-container');
      var errorMessage = document.getElementById('error-message');
      
      if (loadingIndicator) {
        loadingIndicator.style.display = 'none';
      }
      
      if (loadingText) {
        loadingText.style.display = 'none';
      }
      
      if (errorContainer) {
        errorContainer.style.display = 'block';
      }
      
      if (errorMessage) {
        errorMessage.textContent = message || '앱을 로드하는 중 오류가 발생했습니다.';
      }
    };
    
    // 이미지 오류 처리
    window.addEventListener('error', function(e) {
      if (e.target.tagName && e.target.tagName.toLowerCase() === 'img') {
        console.warn('이미지 로딩 오류 감지:', e.target.src);
        e.target.style.display = 'none'; // 오류 이미지 숨기기
        e.preventDefault(); // 오류 전파 방지
      }
    }, true);
    
    // Flutter 초기화 오류 처리
    window.addEventListener('flutter-initialization-error', function(e) {
      console.error('Flutter 초기화 오류:', e.detail);
      window.showError('Flutter 초기화 오류: ' + e.detail);
    });
    
    // Flutter 초기화 완료 이벤트 리스너
    window.addEventListener('flutter-first-frame', function() {
      console.log('Flutter 첫 프레임 렌더링 완료');
      window.hideLoading();
    });
    
    // 앱 초기화 함수
    window.startApp = function() {
      try {
        console.log('Flutter 앱 초기화 시작');
        
        // Flutter 초기화 확인
        if (!window.flutter) {
          console.error('Flutter 객체가 정의되지 않았습니다');
          window.showError('Flutter 초기화 실패: Flutter 객체가 존재하지 않습니다.');
          return;
        }
        
        if (!window.flutter.loader) {
          console.error('Flutter 로더가 정의되지 않았습니다');
          window.showError('Flutter 초기화 실패: Flutter 로더가 존재하지 않습니다.');
          return;
        }
        
        if (typeof window.flutter.loader.loadEntrypoint !== 'function') {
          console.error('Flutter 로더 함수가 정의되지 않았습니다');
          
          // 대체 방법 시도
          console.log('대체 방법으로 앱 로드 시도 중...');
          var script = document.createElement('script');
          script.src = 'main.dart.js';
          script.type = 'application/javascript';
          document.body.appendChild(script);
          return;
        }
        
        // Flutter 엔트리포인트 로드
        window.flutter.loader.loadEntrypoint({
          serviceWorker: {
            serviceWorkerVersion: serviceWorkerVersion,
          },
          onEntrypointLoaded: function(engineInitializer) {
            console.log('Flutter 엔진 초기화 중...');
            engineInitializer.initializeEngine({
              hostElement: document.querySelector('#flutter_target')
            }).then(function(appRunner) {
              console.log('Flutter 앱 실행 중...');
              appRunner.runApp();
            }).catch(function(error) {
              console.error('Flutter 앱 실행 오류:', error);
              window.showError('Flutter 앱 실행 오류: ' + error.message);
            });
          },
          onError: function(error) {
            console.error('Flutter 로딩 오류:', error);
            window.showError('Flutter 로딩 오류: ' + error);
          }
        });
      } catch (e) {
        console.error('Flutter 앱 시작 오류:', e);
        window.showError('Flutter 앱 시작 중 오류 발생: ' + e.message);
        
        // 대체 방법 시도
        try {
          console.log('대체 방법으로 앱 로드 시도 중...');
          var script = document.createElement('script');
          script.src = 'main.dart.js';
          script.type = 'application/javascript';
          document.body.appendChild(script);
        } catch (scriptError) {
          console.error('대체 메서드 실패:', scriptError);
        }
      }
    };
    
    // 앱 시작 함수
    window.addEventListener('load', function() {
      // Flutter.js 로드 확인
      if (window.flutter) {
        window.startApp();
      } else {
        // flutter.js 스크립트 로드 확인
        var flutterScripts = document.querySelectorAll('script[src="flutter.js"]');
        if (flutterScripts.length === 0) {
          console.error('flutter.js 스크립트가 로드되지 않았습니다.');
          
          // flutter.js 스크립트 동적 추가
          var script = document.createElement('script');
          script.src = 'flutter.js';
          script.onload = function() {
            console.log('flutter.js 동적 로드 완료');
            
            // flutter.js가 로드된 후 start 함수 호출
            setTimeout(function() {
              window.startApp();
            }, 500);
          };
          script.onerror = function(e) {
            console.error('flutter.js 로드 실패:', e);
            window.showError('Flutter 스크립트 로드 실패');
          };
          document.head.appendChild(script);
        } else {
          // flutter.js가 이미 있으나 아직 로드되지 않은 경우 기다림
          console.log('flutter.js 로드 대기 중...');
          
          var waitForFlutterWebInit = function() {
            if (window.flutter) {
              window.startApp();
            } else {
              setTimeout(waitForFlutterWebInit, 100);
            }
          };
          waitForFlutterWebInit();
        }
      }
      
      // 30초 후에도 Flutter가 로드되지 않으면 강제로 대체 방법 시도
      setTimeout(function() {
        if (!window._flutterInitialized) {
          console.warn('30초 타임아웃 후 대체 방법 시도 중...');
          
          try {
            var script = document.createElement('script');
            script.src = 'main.dart.js';
            script.type = 'application/javascript';
            document.body.appendChild(script);
          } catch (e) {
            console.error('대체 메서드 실패:', e);
            window.showError('앱 로드 타임아웃. 페이지를 새로고침하세요.');
          }
        }
      }, 30000);
    });
    
    // Flutter 초기화 성공 플래그
    window._flutterInitialized = false;
  </script>
</body>
</html> 