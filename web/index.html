<!DOCTYPE html>
<html>
<head>
  <!--
    If you are serving your web app in a path other than the root, change the
    href value below to reflect the base path you are serving from.

    The path provided below has to start and end with a slash "/" in order for
    it to work correctly.

    For more details:
    * https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base

    This is a placeholder for base href that will be replaced by the value of
    the `--base-href` argument provided to `flutter build`.
  -->
  <base href="$FLUTTER_BASE_HREF">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="PDF Learner - AI PDF 학습 도우미">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Content Security Policy 추가 -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://apis.google.com https://www.gstatic.com https://www.googletagmanager.com 'unsafe-inline' 'unsafe-eval'; style-src 'self' https://fonts.googleapis.com 'unsafe-inline'; font-src 'self' https://fonts.gstatic.com; img-src 'self' https://storage.googleapis.com data: blob:; connect-src 'self' https://*.googleapis.com https://*.firebaseio.com wss://*.firebaseio.com https://*.cloudfunctions.net https://firebase.googleapis.com https://*.google.com; frame-src 'self' https://*.firebaseapp.com;">
  
  <!-- 캐시 무효화 -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- 개발자 도구 소스맵 비활성화 -->
  <meta name="devtools-source-maps" content="false">

  <!-- iOS meta tags & icons -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="PDF Learner">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Google Sign-In Client ID - 환경 변수 사용 -->
  <meta name="google-signin-client_id" content="__GOOGLE_CLIENT_ID__">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>PDF Learner</title>
  <link rel="manifest" href="manifest.json">

  <!-- Flutter 초기화 스크립트 -->
  <script>
    // 서비스 워커 버전
    var serviceWorkerVersion = null;
    
    // 프로덕션 모드 여부 확인
    var isDevMode = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    
    // 프로덕션 환경에서 콘솔 로그 제어
    if (!isDevMode) {
      var originalConsole = {
        log: console.log,
        warn: console.warn,
        error: console.error,
        info: console.info,
        debug: console.debug
      };
      
      // 중요 로그만 출력하도록 로그 필터링
      console.log = function() {
        var msg = Array.from(arguments).join(' ');
        if (msg.includes('오류') || 
            msg.includes('실패') || 
            msg.includes('완료') || 
            msg.includes('Flutter 첫 프레임')) {
          originalConsole.log.apply(console, arguments);
        }
      };
      
      console.error = function() {
        var msg = Array.from(arguments).join(' ');
        // Cross-Origin-Opener-Policy 관련 오류 필터링
        if (!msg.includes('Cross-Origin-Opener-Policy') && 
            !msg.includes('window.closed')) {
          originalConsole.error.apply(console, arguments);
        }
      };
      
      console.warn = function() {
        // 경고 메시지 필터링
        var msg = Array.from(arguments).join(' ');
        if (!msg.includes('TrustedTypes') && 
            !msg.includes('Initializing Firebase') && 
            !msg.includes('setTimeout') && 
            !msg.includes('handler took') &&
            !msg.includes('Cross-Origin-Opener-Policy')) {
          originalConsole.warn.apply(console, arguments);
        }
      };
      
      // 정보 및 디버그 로그 비활성화
      console.info = function() {};
      console.debug = function() {};
      
      // Violation 경고 비활성화
      window.__defineGetter__('onviolation', function() { return null; });
      
      // Firebase 오류 필터링 - 오류 이벤트 리스너 오버라이드
      window.addEventListener('error', function(event) {
        if (event.message && (
            event.message.includes('Cross-Origin-Opener-Policy') || 
            event.message.includes('window.closed'))) {
          event.preventDefault();
          event.stopPropagation();
          return false;
        }
      }, true);
    }
  </script>
  <!-- main.dart.js 파일 직접 로드 (flutter.js 우회) -->
  <script src="main.dart.js" defer></script>
  
  <!-- 성능 최적화: 주요 스타일 인라인 포함 -->
  <style>
    body {
      background-color: #FFFFFF;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
      margin: 0;
      padding: 0;
      position: fixed;
    }
    
    #flutter_target {
      width: 100%;
      height: 100%;
      opacity: 0;
      transition: opacity 0.5s ease-in;
    }
    
    #flutter_target.visible {
      opacity: 1;
    }
    
    #loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%;
      width: 100%;
      position: absolute;
      top: 0;
      left: 0;
      background-color: white;
      flex-direction: column;
      z-index: 9999;
      opacity: 1;
      transition: opacity 0.8s ease;
    }
    
    #loading.fade-out {
      opacity: 0;
      pointer-events: none;
    }
    
    .loader {
      border: 8px solid #f3f3f3;
      border-radius: 50%;
      border-top: 8px solid #1976D2;
      width: 60px;
      height: 60px;
      animation: spin 2s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      margin-top: 20px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 18px;
      color: #666;
    }
    
    #error-container {
      display: none;
      color: red;
      text-align: center;
      padding: 20px;
    }
    
    .progress-bar-container {
      width: 80%;
      max-width: 300px;
      height: 4px;
      background-color: #f3f3f3;
      border-radius: 2px;
      margin-top: 10px;
      overflow: hidden;
    }
    
    .progress-bar {
      height: 100%;
      width: 0%;
      background-color: #1976D2;
      transition: width 0.3s ease;
    }
  </style>
</head>
<body>
  <!-- Flutter 앱이 렌더링될 요소 -->
  <div id="flutter_target" style="width: 100%; height: 100%;"></div>
  
  <!-- 로딩 화면 -->
  <div id="loading">
    <div class="loader"></div>
    <div class="loading-text">PDF Learner 로딩 중...</div>
    <div class="progress-bar-container">
      <div class="progress-bar"></div>
    </div>
    <div id="error-container">
      <h2>앱 로드 실패</h2>
      <p id="error-message">앱을 로드하는 중 오류가 발생했습니다.</p>
      <button onclick="window.location.reload()" style="padding: 10px 20px; margin-top: 20px; cursor: pointer;">
        새로고침
      </button>
    </div>
  </div>

  <script>
    // Firebase 설정 - 환경 변수로 대체
    const firebaseConfig = {
      apiKey: "__FIREBASE_API_KEY__",
      authDomain: "__FIREBASE_AUTH_DOMAIN__",
      projectId: "__FIREBASE_PROJECT_ID__",
      storageBucket: "__FIREBASE_STORAGE_BUCKET__",
      messagingSenderId: "__FIREBASE_MESSAGING_SENDER_ID__",
      appId: "__FIREBASE_APP_ID__",
      measurementId: "__FIREBASE_MEASUREMENT_ID__"
    };
    
    // 로딩 진행 상태
    let loadingProgress = 0;
    
    // 진행 표시줄 업데이트 함수
    function updateProgressBar(progress) {
      const progressBar = document.querySelector('.progress-bar');
      if (progressBar) {
        progressBar.style.width = `${progress}%`;
      }
      
      const loadingText = document.querySelector('.loading-text');
      if (loadingText && progress > 0) {
        loadingText.textContent = `PDF Learner 로딩 중... ${Math.floor(progress)}%`;
      }
    }
    
    // 로딩 화면 숨기기 함수
    window.hideLoading = function() {
      var loadingElement = document.getElementById('loading');
      var flutterTarget = document.getElementById('flutter_target');
      
      if (flutterTarget) {
        // Flutter 앱 먼저 표시
        flutterTarget.classList.add('visible');
      }
      
      if (loadingElement) {
        // 로딩 화면 페이드 아웃
        loadingElement.classList.add('fade-out');
        
        // 애니메이션 완료 후 제거
        setTimeout(function() {
          loadingElement.style.display = 'none';
        }, 800); // CSS 전환 시간과 일치
      }
    };
    
    // 오류 표시 함수
    window.showError = function(message) {
      var loadingIndicator = document.querySelector('.loader');
      var loadingText = document.querySelector('.loading-text');
      var errorContainer = document.getElementById('error-container');
      var errorMessage = document.getElementById('error-message');
      
      if (loadingIndicator) {
        loadingIndicator.style.display = 'none';
      }
      
      if (loadingText) {
        loadingText.style.display = 'none';
      }
      
      if (errorContainer) {
        errorContainer.style.display = 'block';
      }
      
      if (errorMessage) {
        errorMessage.textContent = message || '앱을 로드하는 중 오류가 발생했습니다.';
      }
    };
    
    // Firebase SDK 로드 (간단한 방식)
    function loadFirebaseSDK() {
      const script = document.createElement('script');
      script.src = 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js';
      document.head.appendChild(script);
      
      return new Promise(resolve => {
        script.onload = () => {
          console.log('Firebase 로드됨');
          
          if (window.firebase) {
            window.firebase.initializeApp(firebaseConfig);
          }
          
          updateProgressBar(30);
          resolve();
        };
        
        script.onerror = () => {
          console.warn('Firebase 로드 실패');
          updateProgressBar(30);
          resolve();
        };
      });
    }
    
    // 사용자 정보 가져오기 함수 - Flutter에서 호출
    window.getUserDetails = function() {
      try {
        // Firebase 인증 정보 확인
        if (typeof firebase !== 'undefined' && firebase.auth) {
          var user = firebase.auth().currentUser;
          if (user) {
            console.log('Firebase에서 인증된 사용자 발견: ' + user.uid);
            return {
              uid: user.uid,
              email: user.email || '',
              displayName: user.displayName || '',
              isAnonymous: false
            };
          }
        }
        
        // 로컬 스토리지에서 확인
        var storedUserInfo = localStorage.getItem('user_info');
        if (storedUserInfo) {
          var userInfo = JSON.parse(storedUserInfo);
          console.log('로컬 스토리지에서 사용자 정보 발견: ' + userInfo.uid);
          return userInfo;
        }
        
        console.log('사용자 정보를 찾을 수 없음');
        return {
          uid: '',
          email: '',
          displayName: '',
          isAnonymous: true
        };
      } catch (e) {
        console.error('사용자 정보 가져오기 오류: ' + e);
        return {
          uid: '',
          email: '',
          displayName: '',
          isAnonymous: true
        };
      }
    };
    
    window.pdfl = {
      getCurrentFirebaseUser: window.getUserDetails,
      getStoredUserInfo: window.getUserDetails,
      
      // Firebase 상태 확인 함수
      checkFirebaseStatus: function() {
        if (typeof firebase !== 'undefined') {
          const auth = firebase.auth && firebase.auth();
          const user = auth && auth.currentUser;
          
          return {
            initialized: true,
            userLoggedIn: !!user,
            userId: user ? user.uid : null
          };
        }
        
        return {
          initialized: false,
          userLoggedIn: false,
          userId: null
        };
      }
    };

    // Flutter 첫 프레임 이벤트 리스너
    window.addEventListener('flutter-first-frame', function() {
      console.log('Flutter 첫 프레임 완료');
      hideLoading();
      
      // 나머지 Firebase SDK 지연 로드
      setTimeout(() => {
        const authScript = document.createElement('script');
        authScript.src = 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js';
        document.head.appendChild(authScript);
        
        const firestoreScript = document.createElement('script');
        firestoreScript.src = 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js';
        document.head.appendChild(firestoreScript);
        
        const storageScript = document.createElement('script');
        storageScript.src = 'https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js';
        document.head.appendChild(storageScript);
      }, 1000);
    }, { once: true }); // 한 번만 실행되도록 설정

    // 이미지 오류 처리
    window.addEventListener('error', function(e) {
      if (e.target.tagName && e.target.tagName.toLowerCase() === 'img') {
        e.target.style.display = 'none';
        e.preventDefault();
      }
    }, true);

    // Flutter 앱 로딩 - Flutter 공식 문서 방식
    window.addEventListener('load', function() {
      console.log('페이지 로드됨, Flutter 초기화 시작');
      updateProgressBar(10);
      
      // Firebase 미리 로드
      loadFirebaseSDK().then(() => {
        console.log('Firebase 초기화 완료, Flutter 로드 시작');
        updateProgressBar(40);
        
        // Flutter 앱이 자동으로 로드됨 (main.dart.js가 <head>에 포함되어 있음)
        console.log('Flutter 앱 로드 중...');
        updateProgressBar(60);
        
        // 30초 타임아웃 설정
        setTimeout(() => {
          if (document.getElementById('loading').style.display !== 'none') {
            console.error('Flutter 로딩 타임아웃');
            showError('앱 로딩 시간이 너무 오래 걸립니다. 페이지를 새로고침하세요.');
          }
        }, 30000);
      }).catch(e => {
        console.error('앱 초기화 오류:', e);
        showError('앱 초기화 오류: ' + e.message);
      });
    });
  </script>
</body>
</html> 